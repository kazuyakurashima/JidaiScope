# PRD（要件定義書）v2.1

## プロジェクトコードネーム：ChronosEdge（クロノス・エッジ）

### 「時間の距離」を体感できる、真比率ズーム・タイムライン日本史アプリ

> **「1000年も、1分も、正しい長さで。」**

---

## 1. エグゼクティブサマリー

**What（何を作るか）**
日本史の全時代を「真比率タイムライン」で表現し、ピンチズームで時代を探索できるiOSアプリ。

**Why（なぜ作るか）**
「時間の長さ」を視覚・体感で理解できる歴史アプリが存在しない。暗記ではなく「探索」で歴史を学ぶ新体験を提供する。

**How（どう実現するか）**
Expo + React Native + Skiaによる60fpsの滑らかな描画。Apple IAP買い切り課金で持続可能なビジネスモデルを構築。

**Target（誰に届けるか）**
歴史の流れを理解したい学生・社会人・教育者。

---

## 2. 背景と課題

### 2.1 背景

歴史学習における主要なつまずきは、「出来事の暗記」よりも **"時代感覚（どれくらい長いのか）" と "因果の流れ" がつかめない**ことにある。

既存の年表アプリは、情報はあるが **時間の比率（長さ）を体感しにくい**、またはUIが古く、探索が気持ちよくない。

### 2.2 解決したい課題（ユーザー課題）

| 課題                               | 具体例                                              | 解決アプローチ                                 |
| ---------------------------------- | --------------------------------------------------- | ---------------------------------------------- |
| 時代の長短が直感的に把握できない   | 江戸時代（265年）と明治時代（45年）の差が分からない | 真比率タイムラインで「長さ＝時間」を視覚化     |
| 情報がバラバラで「流れ」が見えない | 年号・事件・人物・政権が別々のページに分散          | 同一タイムライン上にレイヤー重ね表示           |
| スマホ画面での情報過多             | 拡大しても文字が潰れる、操作がストレス              | セマンティックズーム（LOD）で粒度を自動調整    |
| 目的の情報に到達できない           | 「明治元年」で検索しても出てこない                  | 西暦・和暦・人物名・事件名でのユニバーサル検索 |

### 2.3 競合分析と差別化

| アプリ/サービス          | 強み       | 弱み                       | ChronosEdgeの差別化              |
| ------------------------ | ---------- | -------------------------- | -------------------------------- |
| 日本史年表（既存アプリ） | 網羅性     | 視覚的に平坦、時間比率なし | 真比率＋ズームで「体感」を提供   |
| 世界史年表アプリ各種     | 世界史対応 | 日本史の深さが不足         | 日本史特化（天皇・将軍レイヤー） |
| Wikipedia年表            | 情報量     | 探索体験なし               | インタラクティブな探索UI         |
| 教科書・参考書           | 信頼性     | 静的、全体俯瞰が困難       | 動的ズーム＋関連リンク           |

**差別化の核心：「時間＝空間」の体感**

- 江戸時代の長さが「スクロール量」で分かる
- 明治維新の密度が「ズームレベル」で分かる
- 空白期間も「余白」として意味を持つ

---

## 3. ビジョン／プロダクト原則

### 3.1 ビジョン

> 歴史を「暗記」から「体験」へ。
> **真比率タイムライン＋顕微鏡ズーム**で、ユーザーが "時間の距離" を身体感覚として理解できる状態を作る。
>
> **「1000年も、1分も、正しい長さで。」**

### 3.2 プロダクト原則（Design Principles）

| 原則                      | 意味                             | 実装への影響                     |
| ------------------------- | -------------------------------- | -------------------------------- |
| **Time is Space**         | 時間の長さは空間の長さとして表現 | 1年＝Nピクセルの真比率描画       |
| **Zoom is Understanding** | 拡大・縮小が理解の導線           | シームレスなセマンティックズーム |
| **Silence is Meaning**    | 空白期間も「時代の重み」         | 空白を美しくデザイン             |
| **One-thumb Exploration** | 片手操作で探索が成立             | 親指リーチ内にコア操作配置       |
| **No Visual Debt**        | 情報密度はズームに応じて段階的に | LOD（Level of Detail）制御       |
| **Delight in Discovery**  | 探索に「発見の喜び」を           | ハプティクス・アニメーション     |

---

## 4. ターゲット／ペルソナ

### 4.1 プライマリペルソナ

**ペルソナA：探究型（教養層）**

- 年齢：25-45歳
- 特徴：大河ドラマや歴史小説好き、時代の流れを俯瞰したい
- 利用シーン：通勤中、就寝前のリラックスタイム
- ニーズ：「眺めて楽しい」「発見がある」

**ペルソナB：学習型（学生）**

- 年齢：15-22歳
- 特徴：定期テスト・受験で時代の位置関係を整理したい
- 利用シーン：試験前の復習、授業の予習
- ニーズ：「素早く目的地に到達」「正確な情報」

**ペルソナC：授業利用（教員）**

- 年齢：30-55歳
- 特徴：授業で視覚教材として使いたい
- 利用シーン：教室での投影・説明
- ニーズ：「全体→詳細のドリルダウン」「滑らかなアニメーション」

### 4.2 ユーザージャーニーマップ（ペルソナA：探究型）

```
[認知] → [インストール] → [初回起動] → [探索] → [発見] → [定着] → [推奨]
   │          │              │           │         │         │         │
   │          │              │           │         │         │         └─ 友人にシェア
   │          │              │           │         │         └─ ブックマーク活用
   │          │              │           │         └─ 「江戸長い！」の気づき
   │          │              │           └─ 時代ジャンプ→ズーム
   │          │              └─ オンボーディング体験
   │          └─ App Store発見
   └─ SNS/口コミ
```

---

## 5. 成功指標（KPI）

### 5.1 North Star Metric

**「探究セッション完了率」**

定義：時代ジャンプまたは検索後、3分以上探索し、イベント詳細を2件以上閲覧したセッションの割合

目標：Week 4で 25%以上

### 5.2 KPIツリー

```
[North Star] 探究セッション完了率 25%
    │
    ├─ [エンゲージメント]
    │      ├─ D1 リテンション: 40%以上
    │      ├─ D7 リテンション: 20%以上
    │      └─ 1セッション平均時間: 5分以上
    │
    ├─ [機能利用]
    │      ├─ 時代ジャンプ利用率: 70%以上
    │      ├─ 検索利用率: 50%以上
    │      └─ ブックマーク率: 15%以上
    │
    ├─ [品質]
    │      ├─ クラッシュフリー率: 99.8%以上
    │      ├─ ストアレビュー: 4.5以上
    │      └─ ANR率: 0.1%以下
    │
    └─ [収益]
           ├─ 課金率: 5%以上
           └─ 課金後30日継続率: 80%以上
```

---

## 6. スコープ

### 6.1 MVP（iOS先行・Expo）

**コンセプト：「眺めるだけで理解が進む」体験を最優先**

| IN（含む）                                       | OUT（含まない）          |
| ------------------------------------------------ | ------------------------ |
| 真比率タイムライン                               | クイズ・学習機能         |
| 時代ジャンプ（Era Picker）                       | 世界史比較ビュー         |
| 基本レイヤー（時代/天皇/幕府/主要人物/主要事件） | エクスポート（画像/PDF） |
| 西暦・和暦・名称検索                             | Android版                |
| ブックマーク（ローカル）                         | アカウント・同期機能     |
| Apple IAP（買い切りPro）                         | サブスクリプション       |
| 主要100件の典拠表示                              | 全件典拠（v1.1で対応）   |

### 6.2 ロードマップ

| Phase | 期間       | 主要機能                                          |
| ----- | ---------- | ------------------------------------------------- |
| MVP   | Sprint 0-4 | コア体験＋課金＋主要100件典拠                     |
| v1.1  | +4週       | 表示モード（Log/Focus）、共有リンク、全件典拠対応 |
| v1.2  | +4週       | 比較ビュー（日本史×世界史）                       |
| v2.0  | +8週       | Android版、クラウド同期                           |

---

## 7. 主要体験（ユーザーストーリー）

### 7.1 コアストーリー

```
1. アプリを開く
   └─ 日本史の全体像（縄文〜令和）が一本の真比率タイムラインとして表示
   └─ ダークテーマで没入感のある「夜の博物館」体験

2. 時代をタップ（Era Picker）
   └─ 「江戸時代」→該当地点へスムーズにアニメーション移動
   └─ 時代境界通過時に軽いハプティクス

3. ピンチでズーム
   └─ 江戸の中の主要出来事が段階的に現れる（LOD）
   └─ 年→月の解像度変化時に「カチッ」と触覚フィードバック

4. 将軍の代替わりを確認
   └─ 徳川将軍1〜15代が視覚的な帯として流れで見える

5. 事件カードを開く
   └─ 関連人物・関連事件への横移動が可能
   └─ 主要イベントには典拠（出典）を表示

6. 重要地点をブックマーク
   └─ 後で復習・共有
```

### 7.2 ユーザーストーリー一覧（優先度付き）

| ID    | ストーリー                                       | 優先度 | MVP        |
| ----- | ------------------------------------------------ | ------ | ---------- |
| US-01 | 縄文〜令和の全体タイムラインを一目で見たい       | Must   | ✓          |
| US-02 | 江戸→明治がどれだけ短いかを「長さ」で理解したい  | Must   | ✓          |
| US-03 | 織田信長→秀吉→家康の時間関係を一目で把握したい   | Must   | ✓          |
| US-04 | 明治元年（和暦）で検索して該当地点へ飛びたい     | Must   | ✓          |
| US-05 | 徳川将軍15代の在任期間を視覚的に比較したい       | Must   | ✓          |
| US-06 | 授業で「今から幕末へズーム」を滑らかに見せたい   | Must   | ✓          |
| US-07 | 気になった出来事をブックマークして後で見返したい | Should | ✓          |
| US-08 | 重要な出来事の情報源（典拠）を確認したい         | Should | ✓（100件） |
| US-09 | 日本史と世界史を並べて同時代を比較したい         | Could  | -          |
| US-10 | タイムラインを画像でシェアしたい                 | Could  | -          |

---

## 8. 機能要件（Functional Requirements）

### 8.1 タイムライン表示（最重要）

#### FR-01：真比率スケール（True-Ratio）

| 項目       | 仕様                                       |
| ---------- | ------------------------------------------ |
| 基本単位   | 1年 = N ピクセル（ズームレベルで可変）     |
| 最小ズーム | 全体俯瞰（縄文〜令和が1画面）              |
| 最大ズーム | 月単位表示（重要期間のみ）                 |
| 表示モード | Linear（真比率）をMVP基本、Log/Focusはv1.1 |

#### FR-02：セマンティックズーム（LOD: Level of Detail）

| Level | 表示内容                     | トリガー（zoom factor目安） |
| ----- | ---------------------------- | --------------------------- |
| L0    | 時代名のみ                   | x1〜x2                      |
| L1    | 時代＋主要出来事（30件程度） | x2〜x10                     |
| L2    | 年単位＋中規模出来事         | x10〜x50                    |
| L3    | 月日単位＋詳細出来事         | x50以上                     |

#### FR-03：操作仕様

| 操作         | 動作              | 実装要件             |
| ------------ | ----------------- | -------------------- |
| ピンチ       | ズームイン/アウト | Gesture Handler統合  |
| ドラッグ     | 横スクロール      | 慣性スクロール対応   |
| タップ       | イベント選択      | ヒット領域は最小44pt |
| ダブルタップ | 段階ズームイン    | x2倍ずつ             |
| 長押し       | プレビュー表示    | 0.5秒後に発火        |

#### FR-04：ハプティクスフィードバック

| トリガー                        | フィードバック    | デフォルト |
| ------------------------------- | ----------------- | ---------- |
| 時代境界通過                    | Light impact      | ON         |
| 重要イベント通過                | Medium impact     | ON         |
| ズームレベル切替（L0↔L1↔L2↔L3） | Selection変更     | ON         |
| 年→月の目盛り出現（解像度変化） | Selection（繊細） | **OFF**    |

※「年→月の目盛り出現」は高頻度で発火するため、デフォルトOFFとし、設定で有効化可能とする。ユーザーテストで好評であればv1.1以降でデフォルトONを検討。

### 8.2 時代ジャンプ（Era Picker）

#### FR-05：Era Picker仕様

| 項目           | 仕様                                 |
| -------------- | ------------------------------------ |
| 表示位置       | 画面上部（常時表示/縮小可能）        |
| 時代表示       | 横並び帯（幅＝期間比率）             |
| タップ動作     | 該当時代開始地点へアニメーション移動 |
| アニメーション | 300-500ms、ease-out                  |

### 8.3 レイヤー

#### FR-06：MVPレイヤー一覧

| レイヤー     | 表示形式   | Free | Pro  |
| ------------ | ---------- | ---- | ---- |
| 時代区分     | 背景帯     | ✓    | ✓    |
| 主要事件     | 点/縦線    | ✓    | ✓    |
| 天皇         | 在位期間帯 | 一部 | 全て |
| 将軍（幕府） | 在任期間帯 | 一部 | 全て |
| 主要人物     | 活動期間帯 | 一部 | 全て |

#### FR-07：エンティティ詳細

**イベント詳細カード**

- タイトル、日付（西暦/和暦）
- 概要（100-200字）
- タグ（政治/戦争/文化/外交）
- 関連人物（タップで遷移）
- 関連イベント（タップで遷移）
- **典拠（出典）**：主要100件のみMVP対応、小さく表示

**人物詳細カード**

- 氏名、生没年
- 概要（100-200字）
- 主要な役職/称号
- 関連イベント一覧

### 8.4 検索

#### FR-08：検索仕様

| 検索タイプ | 入力例     | 動作                               |
| ---------- | ---------- | ---------------------------------- |
| 西暦       | "1868"     | 該当年へジャンプ                   |
| 和暦       | "明治元年" | 該当年へジャンプ                   |
| 人物名     | "織田信長" | 人物詳細表示＋タイムライン位置     |
| 事件名     | "本能寺"   | イベント詳細表示＋タイムライン位置 |

**検索UX要件**

- インクリメンタルサーチ（2文字以上で発火）
- 検索履歴表示（直近10件）
- ゼロ結果時のサジェスト

### 8.5 ブックマーク

#### FR-09：ブックマーク仕様

| 項目     | 仕様                     |
| -------- | ------------------------ |
| 対象     | イベント、人物、時代     |
| 保存先   | ローカル（AsyncStorage） |
| 上限     | 100件（MVP）             |
| 管理機能 | 追加/削除/一覧表示       |

### 8.6 共有（MVP：軽量）

#### FR-10：共有仕様

| 機能                   | MVP | v1.1 |
| ---------------------- | --- | ---- |
| スクリーンショット共有 | ✓   | ✓    |
| キャプション自動生成   | ✓   | ✓    |
| ディープリンク         | -   | ✓    |

---

## 9. 課金要件（Apple IAP）

### 9.1 課金モデル

| プラン          | 価格             | 内容                         |
| --------------- | ---------------- | ---------------------------- |
| Free            | ¥0               | コア体験（制限付きレイヤー） |
| Pro（買い切り） | ¥480（初期価格） | 全機能解放                   |

**価格テスト計画**

- A/B: ¥320 vs ¥480 vs ¥600
- 指標: 課金率、LTV

### 9.2 Free vs Pro比較

| 機能                 | Free     | Pro  |
| -------------------- | -------- | ---- |
| タイムライン表示     | ✓        | ✓    |
| 時代ジャンプ         | ✓        | ✓    |
| 基本検索             | ✓        | ✓    |
| 天皇レイヤー（全件） | 10代まで | 全て |
| 将軍レイヤー（全件） | 5代まで  | 全て |
| 人物レイヤー         | 20人まで | 全て |
| 高度フィルタ         | -        | ✓    |
| 広告                 | なし     | なし |

### 9.3 Apple要件対応

| 要件                 | 実装                  |
| -------------------- | --------------------- |
| StoreKit 2対応       | react-native-iap v12+ |
| 購入復元             | 設定画面に必須配置    |
| Paywall表示          | Apple HIG準拠         |
| サンドボックステスト | リリース前必須        |

---

## 10. データ要件

### 10.1 MVPデータ範囲

| カテゴリ             | 件数目安         | 備考                     |
| -------------------- | ---------------- | ------------------------ |
| 時代区分             | 15区分           | 縄文〜令和               |
| 主要事件             | 500-800件        | 各時代30-60件            |
| 天皇                 | 126代            | 在位期間                 |
| 将軍                 | 45名程度         | 鎌倉/室町/江戸           |
| 主要人物             | 200-300名        | 活動期間                 |
| **典拠付きイベント** | **100件（MVP）** | 教育現場向け主要イベント |

### 10.2 データモデル

```typescript
// Era（時代）
interface Era {
  id: string;
  name: string;
  nameEn: string;
  startYear: number;
  endYear: number;
  parentEraId?: string;
  color: string;
}

// Event（出来事）
interface Event {
  id: string;
  title: string;
  startDate: string; // ISO 8601
  endDate?: string;
  summary: string;
  tags: ("politics" | "war" | "culture" | "diplomacy")[];
  importanceLevel: 0 | 1 | 2 | 3; // LOD制御用
  eraId: string;
  relatedPersonIds: string[];
  relatedEventIds: string[];
  // v2.1追加：典拠フィールド
  source?: {
    title: string; // 出典名（例：「山川 詳説日本史」）
    page?: string; // ページ番号（任意）
    url?: string; // 参考URL（任意）
  };
}

// Person（人物）
interface Person {
  id: string;
  name: string;
  nameReading: string;
  birthYear?: number;
  deathYear?: number;
  activeStartYear: number;
  activeEndYear: number;
  summary: string;
  roles: string[];
  importanceLevel: 0 | 1 | 2 | 3;
}

// Reign（天皇・将軍在位）
interface Reign {
  id: string;
  personId: string;
  officeType: "emperor" | "shogun_kamakura" | "shogun_muromachi" | "shogun_edo";
  startYear: number;
  endYear: number;
  ordinal: number; // 第N代
}
```

### 10.3 典拠対応方針

| Phase | 対応範囲                     | 件数      |
| ----- | ---------------------------- | --------- |
| MVP   | 教育現場で重要な主要イベント | 100件     |
| v1.1  | 全イベント（段階的追加）     | 500-800件 |

**MVP典拠対象の選定基準：**

1. 教科書に必ず掲載される出来事
2. 入試頻出イベント
3. 因果関係の理解に不可欠なターニングポイント

### 10.4 データ供給方式

| Phase | 方式                     | 理由                               |
| ----- | ------------------------ | ---------------------------------- |
| MVP   | 埋め込み（SQLite）       | オフライン動作、実装速度           |
| v1.1+ | クラウド配信（差分更新） | 誤字修正、追加コンテンツ、典拠拡充 |

---

## 11. UI/UXデザインシステム

### 11.1 テーマ方針

**ダークモードをデフォルトとする**

理由：

- 没入感の向上（「夜の博物館で懐中電灯を持って歩く」体験）
- 長時間の探索でも目が疲れにくい
- 歴史という「過去」を探索する雰囲気に合致
- OLED端末でのバッテリー効率

ライトモードは設定から切替可能とし、v1.1で正式対応。

### 11.2 デザイントークン

#### カラーパレット（ダークテーマ）

```
// Primary（時間軸）
--color-timeline-bg: #0A0E14       // 深い黒（没入感）
--color-timeline-line: #2D3748
--color-era-divider: #4A5568

// Accent
--color-accent-primary: #F6AD55    // オレンジ（発見のハイライト）
--color-accent-secondary: #68D391  // グリーン（成功・確認）

// Era Colors（時代別）
--color-era-jomon: #8B7355
--color-era-yayoi: #7CB342
--color-era-kofun: #5C6BC0
--color-era-asuka: #AB47BC
--color-era-nara: #EF5350
--color-era-heian: #EC407A
--color-era-kamakura: #26A69A
--color-era-muromachi: #66BB6A
--color-era-sengoku: #FF7043
--color-era-edo: #42A5F5
--color-era-meiji: #7E57C2
--color-era-taisho: #26C6DA
--color-era-showa: #9CCC65
--color-era-heisei: #FFCA28
--color-era-reiwa: #FF8A80

// Semantic
--color-text-primary: #F7FAFC
--color-text-secondary: #A0AEC0
--color-text-tertiary: #718096     // 典拠表示用
--color-surface: #1A202C
--color-surface-elevated: #2D3748
```

#### タイポグラフィ

```
// Font Family
--font-primary: 'Hiragino Sans', 'Noto Sans JP', sans-serif
--font-mono: 'SF Mono', monospace

// Scale
--text-xs: 10px    // 典拠表示
--text-sm: 12px
--text-base: 14px
--text-lg: 16px
--text-xl: 20px
--text-2xl: 24px
--text-3xl: 30px

// Weight
--font-normal: 400
--font-medium: 500
--font-bold: 700
```

#### スペーシング

```
--space-1: 4px
--space-2: 8px
--space-3: 12px
--space-4: 16px
--space-5: 20px
--space-6: 24px
--space-8: 32px
--space-10: 40px
--space-12: 48px
```

### 11.3 コンポーネント一覧

| コンポーネント | 用途                   | 状態                      |
| -------------- | ---------------------- | ------------------------- |
| TimelineCanvas | メインタイムライン描画 | -                         |
| EraPickerBar   | 時代ナビゲーション     | default, expanded         |
| EventMarker    | イベント点/線表示      | default, selected, dimmed |
| EventCard      | イベント詳細カード     | -                         |
| PersonCard     | 人物詳細カード         | -                         |
| ReignBar       | 天皇/将軍在位帯        | -                         |
| SearchBar      | 検索入力               | default, focused, loading |
| SearchResult   | 検索結果アイテム       | -                         |
| BookmarkButton | ブックマーク追加/削除  | saved, unsaved            |
| LayerToggle    | レイヤー表示切替       | on, off, locked           |
| ProBadge       | Pro限定表示            | -                         |
| SourceBadge    | 典拠表示（小）         | -                         |

### 11.4 インタラクション仕様

#### アニメーションタイミング

| 種類         | Duration | Easing      |
| ------------ | -------- | ----------- |
| 画面遷移     | 300ms    | ease-out    |
| カード展開   | 250ms    | ease-out    |
| ズーム       | 200ms    | ease-in-out |
| 時代ジャンプ | 400ms    | ease-out    |
| フェード     | 150ms    | linear      |

#### タッチフィードバック

| 操作     | フィードバック                       |
| -------- | ------------------------------------ |
| タップ   | スケール 0.97 + opacity 0.8 (100ms)  |
| 長押し   | スケール 0.95 + ハプティクス (500ms) |
| スワイプ | 慣性継続 + 端で弾性バウンス          |

### 11.5 オンボーディング設計

**初回起動フロー（3ステップ）**

```
[Step 1: ウェルカム]
"1000年も、1分も、正しい長さで。"
- 全体タイムラインのアニメーション表示（ダークテーマ）
- [始める] ボタン

[Step 2: 操作チュートリアル]
"ピンチで時代を探索"
- ズーム操作のコーチマーク
- 実際に操作させて体験
- ハプティクスを体感させる

[Step 3: 時代ジャンプ紹介]
"気になる時代にすぐ移動"
- Era Pickerのハイライト
- タップさせて江戸時代へ移動

[完了: 自由探索へ]
```

**オンボーディング指標**

- 完了率目標: 80%以上
- 各ステップ離脱率追跡

---

## 12. 非機能要件（NFR）

### 12.1 パフォーマンス

| 項目             | 目標値                | 計測方法                    |
| ---------------- | --------------------- | --------------------------- |
| フレームレート   | 60fps（主要デバイス） | Flipper Performance Monitor |
| 起動時間（Cold） | 2秒以内               | TTI計測                     |
| ズームレスポンス | 16ms以内              | frame callback              |
| 検索レスポンス   | 100ms以内             | -                           |
| メモリ使用量     | 200MB以下             | Xcode Instruments           |

**パフォーマンス担保策**

- 可視範囲のみ描画（バーチャライズ）
- 画像の遅延読み込み
- SQLiteインデックス最適化
- Skiaによるネイティブ描画

### 12.2 オフライン対応

| 機能             | オフライン時   |
| ---------------- | -------------- |
| タイムライン表示 | ✓ 完全動作     |
| 検索             | ✓ 完全動作     |
| ブックマーク     | ✓ 完全動作     |
| 課金復元         | × 要オンライン |

### 12.3 アクセシビリティ

| 項目               | 対応レベル                             |
| ------------------ | -------------------------------------- |
| Dynamic Type       | 対応（text-sm〜text-xl）               |
| VoiceOver          | 基本対応（時代名、イベント名読み上げ） |
| Reduce Motion      | 対応（アニメーション簡略化）           |
| カラーコントラスト | WCAG AA準拠                            |

### 12.4 品質基準

| 指標               | 目標      |
| ------------------ | --------- |
| クラッシュフリー率 | 99.8%以上 |
| ANR率              | 0.1%以下  |
| App Storeレビュー  | 4.5以上   |

---

## 13. 技術アーキテクチャ（Expo前提）

### 13.1 技術スタック

| レイヤー       | 技術                         | 理由                       |
| -------------- | ---------------------------- | -------------------------- |
| フレームワーク | Expo SDK 51+                 | OTAアップデート、EAS Build |
| 描画           | @shopify/react-native-skia   | 高fps描画、ズーム性能      |
| ジェスチャー   | react-native-gesture-handler | ピンチ・パン統合           |
| アニメーション | react-native-reanimated      | UIスレッド実行             |
| 状態管理       | Zustand                      | 軽量、TypeScript親和性     |
| ローカルDB     | expo-sqlite                  | Expo互換、SQL検索          |
| 課金           | react-native-iap             | StoreKit 2対応             |
| 解析           | expo-analytics / Amplitude   | イベントトラッキング       |

### 13.2 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                        UI Layer                             │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐          │
│  │Timeline │ │ Search  │ │ Detail  │ │Settings │          │
│  │ Screen  │ │ Screen  │ │ Screen  │ │ Screen  │          │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘          │
│       │           │           │           │                 │
│  ┌────┴───────────┴───────────┴───────────┴────┐           │
│  │              Component Layer                 │           │
│  │  TimelineCanvas │ EraPicker │ Cards │ etc.  │           │
│  └─────────────────────┬───────────────────────┘           │
└────────────────────────┼────────────────────────────────────┘
                         │
┌────────────────────────┼────────────────────────────────────┐
│                  Domain Layer                               │
│  ┌─────────────────────┴───────────────────────┐           │
│  │            Timeline Engine                   │           │
│  │  ┌────────┐ ┌────────┐ ┌────────┐          │           │
│  │  │  Zoom  │ │  LOD   │ │ Layout │          │           │
│  │  │ Manager│ │Manager │ │ Engine │          │           │
│  │  └────────┘ └────────┘ └────────┘          │           │
│  └─────────────────────────────────────────────┘           │
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │   Search    │ │  Bookmark   │ │     IAP     │          │
│  │   Service   │ │   Service   │ │   Service   │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────┬───────────────────────────────────┘
                          │
┌─────────────────────────┼───────────────────────────────────┐
│                   Data Layer                                │
│  ┌──────────────────────┴──────────────────────┐           │
│  │               SQLite (expo-sqlite)           │           │
│  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌──────┐ │           │
│  │  │  Era   │ │ Event  │ │ Person │ │Reign │ │           │
│  │  └────────┘ └────────┘ └────────┘ └──────┘ │           │
│  └─────────────────────────────────────────────┘           │
│                                                             │
│  ┌─────────────────────┐ ┌─────────────────────┐          │
│  │    AsyncStorage     │ │    SecureStore      │          │
│  │   (Bookmarks, etc)  │ │   (IAP receipts)    │          │
│  └─────────────────────┘ └─────────────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

### 13.3 ディレクトリ構成

```
/
├── app/                    # Expo Router screens
│   ├── (tabs)/
│   │   ├── index.tsx       # Timeline (Home)
│   │   ├── search.tsx      # Search
│   │   └── bookmarks.tsx   # Bookmarks
│   ├── event/[id].tsx      # Event Detail
│   ├── person/[id].tsx     # Person Detail
│   └── settings.tsx        # Settings
│
├── components/
│   ├── timeline/           # Timeline関連
│   │   ├── TimelineCanvas.tsx
│   │   ├── EraPickerBar.tsx
│   │   ├── EventMarker.tsx
│   │   └── ReignBar.tsx
│   ├── cards/              # 詳細カード
│   ├── search/             # 検索UI
│   └── common/             # 共通コンポーネント
│
├── domain/
│   ├── timeline/           # タイムラインエンジン
│   │   ├── zoomManager.ts
│   │   ├── lodManager.ts
│   │   └── layoutEngine.ts
│   ├── search/
│   └── bookmark/
│
├── data/
│   ├── database/           # SQLite操作
│   ├── repositories/       # データアクセス
│   └── seed/               # 初期データ
│
├── stores/                 # Zustand stores
│   ├── timelineStore.ts
│   ├── searchStore.ts
│   └── iapStore.ts
│
├── hooks/                  # カスタムフック
├── utils/                  # ユーティリティ
├── constants/              # 定数・トークン
└── types/                  # TypeScript型定義
```

### 13.4 Expo固有の考慮事項

| 項目                 | 対応                                           |
| -------------------- | ---------------------------------------------- |
| Skia互換性           | Expo SDK 51+で公式対応確認済み                 |
| EAS Build            | production/preview/developmentプロファイル設定 |
| OTAアップデート      | expo-updates（JSバンドルのみ）                 |
| ネイティブモジュール | Development Buildで対応                        |

---

## 14. 画面一覧（MVP）

| #   | 画面名          | 主要機能                                     | 遷移元                    |
| --- | --------------- | -------------------------------------------- | ------------------------- |
| 1   | Timeline (Home) | タイムライン表示、Era Picker、レイヤー切替   | -                         |
| 2   | Search          | 検索入力、結果一覧                           | Home (検索アイコン)       |
| 3   | Event Detail    | イベント詳細、関連リンク、典拠表示           | Timeline (イベントタップ) |
| 4   | Person Detail   | 人物詳細、関連イベント                       | Event Detail, Search      |
| 5   | Bookmarks       | 保存済み一覧                                 | タブ                      |
| 6   | Settings        | レイヤー設定、ハプティクス、テーマ、購入復元 | タブ                      |
| 7   | Paywall         | Pro案内、購入、復元                          | 各所（ロック機能タップ）  |
| 8   | Onboarding      | 初回チュートリアル                           | 初回起動時                |

---

## 15. テスト戦略

### 15.1 テストピラミッド

```
         /\
        /  \  E2E (10%)
       /────\  - Detox: 主要ユーザーフロー
      /      \
     /────────\  Integration (20%)
    /          \  - 画面遷移、データフロー
   /────────────\
  /              \  Unit (70%)
 /                \  - Domain logic, Utils
/──────────────────\
```

### 15.2 テスト項目

| 種類        | 対象                                  | ツール                |
| ----------- | ------------------------------------- | --------------------- |
| Unit        | ZoomManager, LODManager, Search logic | Jest                  |
| Integration | Screen間データフロー                  | React Testing Library |
| E2E         | 主要ユーザーフロー                    | Detox                 |
| Performance | フレームレート、起動時間              | Flipper               |
| IAP         | 購入・復元フロー                      | Sandbox環境           |

### 15.3 UXテスト計画

| Phase  | 手法       | 参加者     | 目的               |
| ------ | ---------- | ---------- | ------------------ |
| Alpha  | 社内テスト | 5名        | 致命的UX問題の発見 |
| Beta   | TestFlight | 50名       | 実利用環境での検証 |
| Launch | A/Bテスト  | 全ユーザー | 課金率最適化       |

---

## 16. リスクと対策

| #   | リスク                         | 影響度 | 発生確率 | 対策                                                                                               |
| --- | ------------------------------ | ------ | -------- | -------------------------------------------------------------------------------------------------- |
| 1   | 近現代の情報密集で描画破綻     | 高     | 中       | **Sprint 0で幕末〜明治の密集区間を重点検証**。LOD設計を初期から組み込み、v1.1でLog/Focusモード追加 |
| 2   | Skia + Expo互換性問題          | 高     | 低       | SDK 51+で検証済み、Sprint 0でプロトタイプ検証                                                      |
| 3   | データ整合性（人物・事件関係） | 中     | 中       | MVPは関係最小化、重要リンクのみ手動キュレーション                                                  |
| 4   | 課金価値が伝わらない           | 中     | 中       | Paywallでの体験差明示、A/Bテストで最適化                                                           |
| 5   | App Store審査リジェクト        | 中     | 低       | Apple HIG準拠、IAP実装のベストプラクティス遵守                                                     |
| 6   | パフォーマンス目標未達         | 高     | 中       | Sprint 0でベンチマーク、早期にボトルネック特定                                                     |
| 7   | ハプティクス過多による煩わしさ | 低     | 中       | 繊細なフィードバックはデフォルトOFF、ユーザーテストで調整                                          |

---

## 17. 開発スケジュール（提案）

### 17.1 Sprint計画

| Sprint | 期間     | 目標         | 主要タスク                                                             |
| ------ | -------- | ------------ | ---------------------------------------------------------------------- |
| 0      | Week 1   | 技術検証     | Skia描画PoC、ズーム・スクロール、LOD切替、**幕末〜明治の密集描画検証** |
| 1      | Week 2-3 | コアUI       | TimelineCanvas、Era Picker、基本データ表示、ダークテーマ               |
| 2      | Week 3-4 | 機能実装①    | 検索、イベント詳細（典拠表示含む）、人物詳細                           |
| 3      | Week 4-5 | 機能実装②    | ブックマーク、設定（ハプティクス切替）、レイヤー切替                   |
| 4      | Week 5-6 | 課金・品質   | IAP実装、オンボーディング、バグ修正                                    |
| 5      | Week 6-7 | リリース準備 | TestFlight、ASO、審査提出                                              |

### 17.2 マイルストーン

| マイルストーン  | 時期     | 判定基準                                               |
| --------------- | -------- | ------------------------------------------------------ |
| Tech Validation | Week 1末 | Skia + Expoで60fps達成、**幕末〜明治密集でも破綻なし** |
| Alpha           | Week 4末 | 主要機能動作、社内テスト可能                           |
| Beta            | Week 5末 | TestFlight配布可能                                     |
| RC              | Week 6末 | 審査提出可能状態                                       |
| Launch          | Week 7末 | App Store公開                                          |

### 17.3 Sprint 0検証項目（詳細）

Sprint 0は技術的リスクの早期検証が目的。以下を必須検証項目とする：

| #   | 検証項目               | 成功基準                  | 失敗時の対応                           |
| --- | ---------------------- | ------------------------- | -------------------------------------- |
| 1   | Skia + Expo互換性      | サンプル描画が動作        | Expo Go断念、Development Build前提     |
| 2   | ピンチズーム60fps      | 主要端末で60fps維持       | 描画最適化、バーチャライズ強化         |
| 3   | LOD切替の滑らかさ      | カクつきなし              | アニメーション調整                     |
| 4   | **幕末〜明治密集描画** | 50件/10年でも可読性維持   | LODルール見直し、v1.0でLog/Focus前倒し |
| 5   | ハプティクス統合       | Gesture + Haptics連携動作 | ライブラリ選定見直し                   |

---

## 18. MVP完了判定基準（Definition of Done）

### 18.1 機能面

- [ ] 縄文〜令和の全体タイムラインが表示される
- [ ] 時代ジャンプで該当時代へアニメーション移動する
- [ ] ピンチズームでLODが段階的に切り替わる（カクつきなし）
- [ ] 江戸時代の中で将軍15代が帯で見える
- [ ] 検索（西暦・和暦・人物・事件）でジャンプできる
- [ ] イベント詳細が開け、戻り導線が迷子にならない
- [ ] 主要100件のイベントに典拠が表示される
- [ ] ブックマーク追加・削除・一覧表示ができる
- [ ] IAP購入・復元が正常動作する
- [ ] ダークテーマがデフォルトで適用される

### 18.2 品質面

- [ ] 主要デバイス（iPhone 12以降）で60fps維持
- [ ] 起動時間2秒以内
- [ ] クラッシュなし（TestFlight期間中）
- [ ] VoiceOver基本対応
- [ ] ハプティクス設定が正常に動作する

### 18.3 ビジネス面

- [ ] App Store審査通過
- [ ] プライバシーポリシー・利用規約準備完了
- [ ] ASO（タイトル・説明・スクリーンショット）完了

---

## 19. 付録

### 19.1 用語集

| 用語                  | 定義                                                         |
| --------------------- | ------------------------------------------------------------ |
| 真比率タイムライン    | 時間の長さを空間の長さとして正確に表現するタイムライン       |
| LOD (Level of Detail) | ズームレベルに応じて表示する情報の粒度を変える手法           |
| Era Picker            | 時代一覧から選択してジャンプするナビゲーションUI             |
| レイヤー              | タイムライン上に重ねて表示する情報のカテゴリ（天皇、将軍等） |
| 典拠                  | 情報の出典・参考文献                                         |

### 19.2 参考資料

- Apple Human Interface Guidelines
- Expo Documentation (SDK 51+)
- React Native Skia Documentation
- 日本史年表（各種参考書）
- 山川出版社「詳説日本史」（典拠の基準参考）

---

## 20. 変更履歴

| バージョン | 日付       | 変更者 | 変更内容                                       |
| ---------- | ---------- | ------ | ---------------------------------------------- |
| 1.0        | -          | -      | 初版作成                                       |
| 2.0        | 2025-01-24 | PM     | Expo対応、UI/UX設計、競合分析、テスト戦略追加  |
| 2.1        | 2025-01-25 | PM     | デザイナーチームフィードバック反映（下記参照） |

---

# v2.0 → v2.1 変更箇所まとめ

## 1. ビジョン・スローガン追加

- **「1000年も、1分も、正しい長さで。」** をビジョンセクションに追加
- オンボーディングのウェルカム画面にも反映

## 2. ハプティクス仕様強化（FR-04）

- 「年→月の目盛り出現時のSelection feedback」を追加
- **デフォルトOFF**として、ユーザーテスト後に調整する方針を明記
- リスク表に「ハプティクス過多」を追加

## 3. 典拠（データソース）対応

- データモデル（Event）に `source` フィールドを追加
- **MVP: 主要100件のみ典拠対応**、v1.1で全件対応の方針を明記
- 典拠対象の選定基準を追加
- ユーザーストーリー US-08 を追加
- MVPスコープ表、画面一覧に典拠表示を反映

## 4. ダークモードデフォルト化

- セクション11.1「テーマ方針」を新設
- ダークモードをデフォルトとする理由を明記
- 設定画面にテーマ切替を追加

## 5. Sprint 0検証項目の強化

- **「幕末〜明治の密集描画検証」を必須項目に追加**
- セクション17.3「Sprint 0検証項目（詳細）」を新設
- 成功基準と失敗時の対応を明記
- マイルストーン「Tech Validation」の判定基準に密集検証を追加

## 6. その他調整

- リスク表にリスク#7（ハプティクス過多）を追加
- MVP完了判定基準に典拠・ダークテーマ・ハプティクス設定を追加
- 用語集に「典拠」を追加
- カラーパレットに `--color-text-tertiary`（典拠表示用）を追加
